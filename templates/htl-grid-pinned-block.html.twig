{# templates/htl-grid-pinned-block.html.twig #}

{# Debug info - uncomment to enable debugging #}
{#
<div class="htl-grid-debug">
  <strong>Pinned Block Debug:</strong><br>
  Cards: {{ cards|length }}<br>
  Bundle: {{ config.bundle|default('none') }}<br>
  Columns: {{ columns }}, Rows: {{ rows }}<br>
  Layout Preset: {{ config.layoutPreset|default('standard') }}<br>
  Image Position: {{ config.imagePosition|default('top') }}
</div>
#}

{% set cols = columns|default(3) %}
{% set total_slots = (rows|default(1)) * cols %}
{% set layout_preset = config.layoutPreset|default('standard') %}
{% set image_position = config.imagePosition|default('top') %}
{% set card_gap = config.imageSettings.card_gap|default('medium') %}
{% set card_radius = config.imageSettings.card_radius|default('medium') %}

{# Build grid CSS classes #}
{% set grid_classes = [
  'htl-grid',
  'htl-grid--pinned',
  'htl-grid--' ~ layout_preset,
  'htl-grid--image-' ~ image_position,
  'htl-grid--gap-' ~ card_gap,
  'htl-grid--radius-' ~ card_radius
] %}

{% if cards|length > 0 %}
<div class="{{ grid_classes|join(' ') }}" style="--cols: {{ cols }}; --ft-grid-cols: {{ cols }}; --ft-grid-rows: {{ rows|default(1) }};">
  {% for card in cards|slice(0, total_slots) %}
    {# Build card CSS classes based on index and preset #}
    {% set card_classes = ['htl-card', 'htl-card--pinned', 'htl-card--image-' ~ image_position] %}

    {# Add preset-specific classes - use loop.first for first card #}
    {% if layout_preset == 'hero' and loop.first %}
      {% set card_classes = card_classes|merge(['htl-card--hero']) %}
    {% endif %}

    {% if layout_preset == 'featured' and loop.first %}
      {% set card_classes = card_classes|merge(['htl-card--featured']) %}
    {% endif %}

    {% if layout_preset == 'compact' %}
      {% set card_classes = card_classes|merge(['htl-card--compact']) %}
    {% endif %}

    {% if layout_preset == 'horizontal' %}
      {% set card_classes = card_classes|merge(['htl-card--horizontal']) %}
    {% endif %}

    {# Add custom CSS classes from card #}
    {% if card.cssClasses is not empty %}
      {% set card_classes = card_classes|merge([card.cssClasses]) %}
    {% endif %}

    <article class="{{ card_classes|join(' ') }}">





      {# Card inner wrapper for horizontal layouts #}
      <div class="htl-card__inner">

        {# IMAGE SECTION - Rendered based on position #}
        {% if image_position != 'none' and image_position != 'bottom' %}
          {% if card.imageHtml is not empty %}
            <figure class="htl-card__media">
              {{ card.imageHtml|raw }}
              {# Overlay gradient for overlay position #}
              {% if image_position == 'overlay' %}
                <div class="htl-card__media-overlay"></div>
              {% endif %}
            </figure>
          {% elseif card.image is not empty %}
            {# Support for old render array format #}
            <figure class="htl-card__media">
              {{ card.image }}
              {% if image_position == 'overlay' %}
                <div class="htl-card__media-overlay"></div>
              {% endif %}
            </figure>
          {% else %}
            {# Placeholder for cards without images #}
            <div class="htl-card__media-placeholder">
              <span aria-hidden="true">ðŸ“Œ</span>
            </div>
          {% endif %}
        {% endif %}

        {# CONTENT SECTION #}
        <div class="htl-card__content">

          {# Title #}
          <h3 class="htl-card__title">
            {{ card.title }}
          </h3>

          {# META FIELDS (date, teaser, custom fields, etc.) #}
          {% if card.metaItems is not empty %}
            <div class="htl-card__meta">
              {% for item in card.metaItems %}
                {% if item is not empty %}
                  <div class="htl-card__meta-item">
                    {# Render array from FieldRenderer - just output it #}
                    {% if item is iterable and (item['#type'] is defined or item['#markup'] is defined or item['#theme'] is defined) %}
                      {{ item }}
                    {% elseif item is iterable and item.value is defined %}
                      {# Old format: render array with value and class #}
                      <div class="htl-card__meta-row {{ item.class|default('') }}">
                        {{ item.value }}
                      </div>
                    {% elseif item starts with '<' %}
                      {# HTML string - render as raw #}
                      {{ item|raw }}
                    {% else %}
                      {# Plain text or other content #}
                      {{ item }}
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}

        </div>

        {# IMAGE AT BOTTOM - Only if position is 'bottom' #}
        {% if image_position == 'bottom' %}
          {% if card.imageHtml is not empty %}
            <figure class="htl-card__media htl-card__media--bottom">
              {{ card.imageHtml|raw }}
            </figure>
          {% elseif card.image is not empty %}
            <figure class="htl-card__media htl-card__media--bottom">
              {{ card.image }}
            </figure>
          {% endif %}
        {% endif %}

      </div>

      {# Overlay link (makes entire card clickable) #}
      {% if card.url %}
        <a href="{{ card.url }}"
           class="htl-card__overlay"
           aria-label="{{ 'Read more: @title'|t({'@title': card.title}) }}"></a>
      {% endif %}

    </article>
  {% endfor %}
</div>
{% else %}
  {# No pinned content message - can be styled or hidden via CSS #}
  <div class="htl-grid--pinned htl-grid__empty htl-grid__empty--pinned">
    <p>{{ 'No pinned content available.'|t }}</p>
  </div>
{% endif %}
