{# templates/htl-grid-block.html.twig #}

{# Debug info - uncomment to enable debugging #}
{#
<div class="htl-grid-debug">
  <strong>Debug Info:</strong><br>
  Cards: {{ cards|length }}<br>
  Bundle: {{ config.bundle|default('none') }}<br>
  Columns: {{ columns }}, Rows: {{ rows }}<br>
  Layout Preset: {{ config.layoutPreset|default('standard') }}<br>
  Image Position: {{ config.imagePosition|default('top') }}<br>
  Config Fields: {{ config.fields|length|default(0) }}
</div>
#}

{% set cols = columns|default(3) %}
{% set total_slots = (rows|default(2)) * cols %}
{% set layout_preset = config.layoutPreset|default('standard') %}
{% set image_position = config.imagePosition|default('top') %}
{% set card_gap = config.imageSettings.card_gap|default('medium') %}
{% set card_radius = config.imageSettings.card_radius|default('medium') %}

{# Build grid CSS classes #}
{% set grid_classes = [
  'htl-grid',
  'htl-grid--' ~ layout_preset,
  'htl-grid--image-' ~ image_position,
  'htl-grid--gap-' ~ card_gap,
  'htl-grid--radius-' ~ card_radius
] %}

<div class="{{ grid_classes|join(' ') }}" style="--cols: {{ cols }}; --ft-grid-cols: {{ cols }}; --ft-grid-rows: {{ rows|default(2) }};">
  {% for card in cards|slice(0, total_slots) %}
    {# Debug: Uncomment to see card index and classes
    <!-- Card {{ loop.index0 }}: first={{ loop.first ? 'YES' : 'NO' }}, preset={{ layout_preset }} -->
    #}

    {# Build card CSS classes based on index and preset #}
    {% set card_classes = ['htl-card', 'htl-card--image-' ~ image_position] %}

    {# Add preset-specific classes - use loop.first for first card #}
    {% if layout_preset == 'hero' and loop.first %}
      {% set card_classes = card_classes|merge(['htl-card--hero']) %}
    {% endif %}

    {% if layout_preset == 'featured' and loop.first %}
      {% set card_classes = card_classes|merge(['htl-card--featured']) %}
    {% endif %}

    {% if layout_preset == 'compact' %}
      {% set card_classes = card_classes|merge(['htl-card--compact']) %}
    {% endif %}

    {% if layout_preset == 'horizontal' %}
      {% set card_classes = card_classes|merge(['htl-card--horizontal']) %}
    {% endif %}

    {# Add custom CSS classes from card #}
    {% if card.cssClasses is not empty %}
      {% set card_classes = card_classes|merge([card.cssClasses]) %}
    {% endif %}

    <article class="{{ card_classes|join(' ') }}">

      {# Card inner wrapper for horizontal layouts #}
      <div class="htl-card__inner">

        {# IMAGE SECTION - Rendered based on position #}
        {% if image_position != 'none' and image_position != 'bottom' %}
          {% if card.imageHtml is not empty %}
            <figure class="htl-card__media">
              {{ card.imageHtml|raw }}
              {# Overlay gradient for overlay position #}
              {% if image_position == 'overlay' %}
                <div class="htl-card__media-overlay"></div>
              {% endif %}
            </figure>
          {% elseif card.image is not empty %}
            {# Support for old render array format #}
            <figure class="htl-card__media">
              {{ card.image }}
              {% if image_position == 'overlay' %}
                <div class="htl-card__media-overlay"></div>
              {% endif %}
            </figure>
          {% else %}
            {# Placeholder for cards without images #}
            <div class="htl-card__media-placeholder">
              <span aria-hidden="true">ðŸ“°</span>
            </div>
          {% endif %}
        {% endif %}

        {# CONTENT SECTION #}
        <div class="htl-card__content">


          <h3 class="htl-card__title">

            {{ card.title }}

            {% if card.pinned %}
              <span class="htl-card__pinned-label" style="display:inline-block; margin-left:0.5rem; padding:0.1rem 0.4rem; background:#FDE68A; color:#111827; border-radius:4px; font-size:0.75rem; font-weight:700; line-height:1; vertical-align:middle;">Pinned</span>
            {% endif %}
          </h3>


          {# META FIELDS (date, teaser, custom fields, etc.) #}
          {% if card.metaItems is not empty %}
            <div class="htl-card__meta">
              {% for item in card.metaItems %}
                {% if item is not empty %}
                  <div class="htl-card__meta-item">
                    {# Render array from FieldRenderer - just output it #}
                    {% if item is iterable and (item['#type'] is defined or item['#markup'] is defined or item['#theme'] is defined) %}
                      {{ item }}
                    {% elseif item is iterable and item.value is defined %}
                      {# Old format: render array with value and class #}
                      <div class="htl-card__meta-row {{ item.class|default('') }}">
                        {{ item.value }}
                      </div>
                    {% elseif item starts with '<' %}
                      {# HTML string - render as raw #}
                      {{ item|raw }}
                    {% else %}
                      {# Plain text or other content #}
                      {{ item }}
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% elseif card.meta is not empty %}
            {# Support old 'meta' key for backwards compatibility #}
            <div class="htl-card__meta">
              {% for row in card.meta %}
                {% if row is iterable and row.value is defined %}
                  <div class="htl-card__meta-row {{ row.class|default('') }}">
                    {{ row.value }}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}

        </div>

        {# IMAGE AT BOTTOM - Only if position is 'bottom' #}
        {% if image_position == 'bottom' %}
          {% if card.imageHtml is not empty %}
            <figure class="htl-card__media htl-card__media--bottom">
              {{ card.imageHtml|raw }}
            </figure>
          {% elseif card.image is not empty %}
            <figure class="htl-card__media htl-card__media--bottom">
              {{ card.image }}
            </figure>
          {% endif %}
        {% endif %}

      </div>

      {# Overlay link (makes entire card clickable) - placed at end so content is above it in DOM #}
      {% if card.url %}
        <a href="{{ card.url }}"
           class="htl-card__overlay"
           aria-label="Read more: {{ card.title }}"></a>
      {% endif %}

    </article>
  {% else %}
    {# No cards found #}
    <div class="htl-grid__empty">
      <p>No content available. Please configure the block and select fields.</p>
    </div>
  {% endfor %}
</div>

{# View All Button #}
{% if view_all_url %}
  <div class="htl-grid__view-all">
    <a href="{{ view_all_url }}" class="htl-grid__view-all-btn">
      <span>{{ view_all_text|default('View all')|t }}</span>
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="5" y1="12" x2="19" y2="12"></line>
        <polyline points="12 5 19 12 12 19"></polyline>
      </svg>
    </a>
  </div>
{% endif %}
