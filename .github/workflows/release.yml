name: Version Update and Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of release (release or vUpgrade)'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - vUpgrade

permissions:
  contents: write

jobs:
  versioning:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Increment Version and Create Release
        id: version_update
        run: |
          # Hole die aktuelle Version (verwende die bestehende Version aus `composer.json` oder Git-Tag)
          current_version=$(git describe --tags --abbrev=0 || echo "0.0.0")
          major_version=$(echo $current_version | cut -d'.' -f1)
          minor_version=$(echo $current_version | cut -d'.' -f2)
          patch_version=$(echo $current_version | cut -d'.' -f3)

          echo "Aktuelle Version: $current_version"

          # Version erhöhen, abhängig vom Release-Typ
          if [ "${{ github.event.inputs.release_type }}" == "release" ]; then
            # Normale Release: Minor Version erhöhen
            new_version="${major_version}.$((minor_version + 1)).0"
          elif [ "${{ github.event.inputs.release_type }}" == "vUpgrade" ]; then
            # vUpgrade: Major Version erhöhen und Minor auf 0 setzen
            new_version="$((major_version + 1)).0.0"
          else
            echo "Fehler: Ungültiger Release-Typ."
            exit 1
          fi

          echo "Neue Version: $new_version"
          
          # Tag erstellen
          git tag "$new_version"
          git push origin "$new_version"
          
          # Release erstellen
          gh release create "$new_version" --title "Release $new_version" --notes "Automatisch generierter Release."
          
      - name: Commit Version Update
        run: |
          # Commit der neuen Version in composer.json (falls erforderlich)
          jq --arg version "$new_version" '.version = $version' composer.json > temp.json && mv temp.json composer.json
          git add composer.json
          git commit -m "Update version to $new_version"
          git push origin main
